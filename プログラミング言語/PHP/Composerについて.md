# Composerについて

## 説明

PHPのパッケージ管理ツールComposerについて記載する。

- インストールしたパッケージはcomposer.jsonに追記されていく
---
## Composerとは

- PHPの拡張ライブラリをインストールするためのパッケージ管理ツール
- パッケージのインストール・アンインストールをコマンド１つで実行できる
---
## ライブラリの依存関係

- ライブラリ同士の依存関係を解決してライブラリのインストールを実行してくれる。
    - **依存関係**：あるライブラリを動かすのに、別のライブラリが必要になること
    - Composerはライブラリをインストールするとき、依存関係にあるライブラリもインストールしてくれる。
---
## Packgist

- Composer経由で提供されているパッケージについては、[Packagist](https://packagist.org/)から確認できる。
- PHPで記載されているライブラリが多いが、C言語で記載されたライブラリもある
- C言語ベースのライブラリとして有名なのは[PECL](https://pecl.php.net/)
---
## **セマンティックバージョニング**

- Composerで推奨されている、パッケージのバージョン番号を管理するルール
- バージョン番号を以下のように表現する
    - **「メジャーバージョン.マイナーバージョン.パッチ番号」**
    - メジャーバージョンアップ：互換性が保たれない
    - マイナーバージョンアップ：互換性が維持される
    - バッチ番号：バグフィックスなどの微小な変更
- Composerのバージョン指定パターン
    - パッケージインストール時にインストールするバージョンを以下のように指定できる

| 指定パターン例 | 意味 | インストールされるバージョン例 |
| --- | --- | --- |
| 1.5.2 | 1.5.2のみ | 1.5.2 |
| ^1.5.1 | 1.5.1以上、2.0.0未満の最新バージョン | 1.6.0 |
| ~1.5.1 | 1.5.1以上、1.6.0未満の最新バージョン | 1.5.2 |
| ^1.5 | 1.5.0以上、2.0.0未満の最新バージョン | 1.6.0 |
| ~1.5 | 同上 | 同上 |
| 1.5* | 1.5.0以上、1.6.0未満の最新バージョン | 1.5.2 |
| ^1 | ^1.0と同じ意味 | 1.6.0 |
| ~1 | ~1.0と同じ意味 | 1.6.0 |
| 1.* | 1.0.0以上、2.0.0未満の最新バージョン | 1.6.0 |
|  |  |  |
|  |  |  |
|  |  |  |

- アプリ単位にパッケージを管理できる
    - 異なるプラットフォームで動作するアプリで「同じライブラリの異なるバージョン」を利用しても影響が出ない
    - アプリコードとライブラリ（パッケージ）をひとつのフォルダの中でまとめて管理できる
    - アプリ個別にパッケージをインストールすることがデメリット
- **オートローダーについて**
    - Composerでは/vendorフォルダ配下にautoload.php(オートローダー）が用意されている。
    - ライブラリを利用するにあたってはautoload.phpをインクルードするだけで、あとは必要なファイルを自動ロードしてくれる。
    - **自作のクラスをオートロードする方法**
        - composerコマンドでインストールしたパッケージだけでなく、自作のクラスにも適用させることもできる。
        1. composer.jsonに、名前空間とパスのマッピングを記述する
            
            ```json
            composer.json
            
            {
            	"autoload":{
            			"psr-4":{
            						"名前空間1":"自作クラス1のパス",
            						"名前空間2":"自作クラス2のパス",
            						"名前空間3":"自作クラス3のパス"
            			}
            	}
            }
            ```
            
        2. `composer dump-autoload` コマンドを使って、オートローダーを作成
            1. 実行すると、/vender/autoload.phpというファイルが生成される。これがcomposer.jsonに対応するオートーローダークラスとなる。
        3. 自作クラスを使用したい、phpファイルにオートーローダーを使用する宣言を記述する。以上で作業終了。
            1. 
            
            ```php
            require_once_dirname(__FILE__).'/vender/autoload.php';
            ```
            
        

---

## Composerで使用するコマンド

- `composer -v`：Composerのバージョンを確認するコマンド
- `composer require パッケージ名 バージョン名` ：指定したバージョンのパッケージをインストール
- `composer install` ：パッケージをインストールする。
    - composer.lockファイルを優先的に参照してインストールする。.lockファイルがない場合はcomposer.jsonファイルを参照してインストールする。
- `composer update` ：パッケージを最新のバージョンに更新する。
    - composer .jsonファイルを参照してバージョンを更新する。
    - パッケージを一括でupdateすると、パッケージに問題があった場合に、も原因を追いにくいので、なるべく`composer update パッケージ名`でパッケージを指定して、1つずつアップデートする方が良い。
- 
---
## composerコマンドのサブコマンド

- **開発環境でのみ使いたいパッケージを管理する - - devオプション**
    - `composer require —dev パッケージ` ：指定されたライブラリパッケージを開発専用としてインストール　開発時にだけ利用する（＝実行には必要ない)ライブラリをインストールするために利用する。**このオプション付きでインストールされたライブラリはcomposer.jsonのrequire-devキー配下で管理される。**
- **開発環境用パッケージは除外してインストールする —no-devオプション**
    - `composer install —no-dev`：開発向けライブラリ（require-devキー配下で管理されたライブラリ)は除外して、ライブラリをインストールする。
- `composer self-update`：Composer自身を更新
- `composer validate`：composer.jsonに誤りがないか検証
- `composer search 名前`：指定された名前にマッチするライブラリの情報取得
- `composer show -i` ：インストール済みのパッケージの情報を表示
- `composer show -p` ：プラットフォームパッケージ(PHP拡張)の情報を表示
- `composer show パッケージ`：指定されたライブラリパッケージの情報を表示
---
## composer.json

- アプリで利用するライブラリ（パッケージ）の情報が記録されている
- **composer require**コマンドを実行したときに自動で生成される。
- インストールしたパッケージが追記される
- **composer.jsonにライブラリを追加する場合**
    - composer.jsonを編集し、ライブラリを自前で追記した場合は`composer update`を実行することで、ライブラリが更新（不足しているライブラリは追加インストール）される。
- **インストール済みのライブラリを削除する場合**
    - composer.jsonから対象のライブラリを削除したうえで、`composer update`を実行する。
- composer.jsonをアプリのルートに配置した状態で、`composer install`を実行することで必要なライブラリを一括でインストールしてくれるので、異なるコンピューターでも必要なライブラリを即座にインストールしてくれる。
- 
---
## composer.lock

- composer.jsonと異なり、記載されているライブラリのバージョン番号は決め打ち
- パッケージインストール時に以下のことを行う。
    - composer.jsonの内容を解析し、実際にインストールされたバージョンを管理
    - composer.lockファイルを生成・更新
    - 初めてパッケージをインストールした時のバージョンなどが記載される。
- composer.jsonと異なり、開発者が編集することはない。
- **composer.lockファイルが存在する状態で`composer install`を叩くと、パッケージのバージョンに関してはcomposer.lockを参照してインストールされる。**
- **composer.lockファイルが存在する状態で`composer update`を叩くと、composer.jsonの記述を優先してパッケージをインストールする。そのため、以前より新しいバージョンがインストールされる可能性がある。**
- インストールするライブラリのバージョンを完全に再現したい場合には、**composer.json、composer.lock双方を共有してcomposer installする必要がある。**
---
## ライブラリの選定基準

- Composerを使ってライブラリをインストールする場合のライブラリの選定基準
1. issue Listが放置されていないか
    1. [**Packagist**](https://packagist.org/)で該当のライブラリのページの左側に表示されるIssuesをクリックすると、そのライブラリのGit hubリポジトリが開く、
    2. Git hubリポジトリに表示される。以下の項目とその数、放置されている期間を参照する。
        1. Open：対応が未完了の課題数　少ない方が良い
        2. Close：対応完了している課題の数　
        3. 長期間放置されているか課題がないか
2. 最新版のリリース日から長年経過していないか
    1. Packagistのライブラリ個別ページで、バージョン毎のリリース日が確認できる。最新版のリリース日から長年経過していると、最新のフレームワークや外部ソフトに対応していない場合がある。
3. ネットで情報がでてきやすいか
4. 人気、定評があるか